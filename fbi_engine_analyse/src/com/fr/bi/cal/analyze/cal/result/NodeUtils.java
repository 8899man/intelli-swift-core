package com.fr.bi.cal.analyze.cal.result;import com.fr.bi.field.target.key.sum.AvgKey;import com.fr.bi.stable.constant.BIReportConstant;import com.fr.bi.stable.gvi.GVIFactory;import com.fr.bi.stable.gvi.GroupValueIndex;import com.fr.bi.stable.operation.sort.comp.ComparatorFacotry;import com.fr.bi.stable.report.key.TargetGettingKey;import com.fr.bi.stable.report.result.BINode;import com.fr.bi.stable.structure.tree.NTree;/** * Created by Hiram on 2015/1/27. */public class NodeUtils {	    public static Double getTopN(BINode node, TargetGettingKey key, int N) {        Double nLine;        int count = node.getChildLength();        N = Math.min(N, count);        NTree<Double> tree = N < (count << 2) ? new NTree<Double>(ComparatorFacotry.DOUBLE_DESC, N) : new NTree<Double>(ComparatorFacotry.DOUBLE_ASC, count + 1 - N);        for (int i = 0; i < count; i++) {            BINode child = node.getChild(i);            Number v = child.getSummaryValue(key);            if(key.getTargetKey().getSummaryType() == BIReportConstant.SUMMARY_TYPE.AVG){                String targetName = key.getTargetName();                AvgKey avgKey = (AvgKey) key.getTargetKey();                TargetGettingKey sumGettingKey = new TargetGettingKey(avgKey.getSumKey(), targetName);                TargetGettingKey countGettingKey = new TargetGettingKey(avgKey.getCountKey(), targetName);                Number sumValue = child.getSummaryValue(sumGettingKey);                Number countValue = child.getSummaryValue(countGettingKey);                double avgValue = 0;                if (sumValue != null && countValue != null) {                    avgValue = sumValue.doubleValue() / countValue.doubleValue();                }                v = avgValue;            }            if (v != null) {            	tree.add(v.doubleValue());            }        }        nLine = tree.getLineValue();        if(nLine == null){        	nLine = Double.POSITIVE_INFINITY;        }        return nLine;    }    public static void buildParentAndSiblingRelation(BINode root) {        buildSiblingDeepRelation(root);        buildParentDeepRelation(root);        setSiblingBetweenFirstAndLastChild(root);    }    public static void setSiblingBetweenFirstAndLastChild(BINode root) {        for (int i = 0; i < root.getChildLength(); i++) {            BINode parent = root.getChild(i);            if (parent.getChildLength() != 0) {                setSiblingBetweenFirstAndLastChild(parent);            }            if (i + 1 < root.getChildLength()) {                BINode nextParent = root.getChild(i + 1);                BINode tmpLastChild = parent.getLastChild();                BINode tmpFirstChild = nextParent.getFirstChild();                while (tmpLastChild != null && tmpFirstChild != null) {                    tmpLastChild.setSibling(tmpFirstChild);                    tmpLastChild = tmpLastChild.getLastChild();                    tmpFirstChild = tmpFirstChild.getFirstChild();                }            }        }    }    private static void buildSiblingDeepRelation(BINode root) {        buildSiblingRelation(root);        for (int i = 0; i < root.getChildLength(); i++) {            buildSiblingRelation(root.getChild(i));        }    }    private static void buildSiblingRelation(BINode root) {        if (root.getChildLength() < 2) {            return;        }        BINode child = root.getChild(0);        for (int i = 1; i < root.getChildLength(); i++) {            BINode next = root.getChild(i);            child.setSibling(next);            child = next;        }    }    private static void buildParentDeepRelation(BINode root) {        buildParentRelation(root);        for (int i = 0; i < root.getChildLength(); i++) {            buildParentRelation(root.getChild(i));        }    }    private static void buildParentRelation(BINode root) {        for (int i = 0; i < root.getChildLength(); i++) {            BINode child = root.getChild(i);            child.setParent(root);        }    }    public static void reCalculateIndex(BINode node, TargetGettingKey key) {        if (isLeafNode(node)) {            return;        }        GroupValueIndex groupValueIndex = node.getTargetIndexValueMap().get(key);        if (groupValueIndex == null) {            return;        }        GroupValueIndex orGroupValueIndex = GVIFactory.createAllEmptyIndexGVI();        for (int i = 0; i < node.getChildLength(); i++) {            BINode child = node.getChild(i);            reCalculateIndex(child, key);            GroupValueIndex childGroupValueIndex = child.getTargetIndexValueMap().get(key);            if (childGroupValueIndex == null) {                node.getTargetIndexValueMap().put(key, null);            } else {                orGroupValueIndex = orGroupValueIndex.OR(childGroupValueIndex);            }        }        node.getTargetIndexValueMap().put(key, orGroupValueIndex);    }    private static boolean isLeafNode(BINode node) {        return node.getChildLength() == 0;    }}